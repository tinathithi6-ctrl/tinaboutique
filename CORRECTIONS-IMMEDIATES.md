# ‚ö° CORRECTIONS IMM√âDIATES √Ä APPLIQUER

## üéØ OBJECTIF
Rendre l'application fonctionnelle et s√©curis√©e en 48h

---

## üî¥ CORRECTION #1: Badge Panier Dynamique

**Fichier:** `src/components/Header.tsx`

**Ligne 1:** Ajouter l'import du hook
```typescript
import { useCart } from "@/contexts/CartContext";
```

**Ligne 12:** Ajouter apr√®s `const { user, signOut } = useAuth();`
```typescript
const { cartCount } = useCart();
```

**Ligne 156-158:** Remplacer
```typescript
// ‚ùå AVANT
<span className="...">
  0
</span>

// ‚úÖ APR√àS
<span className="...">
  {cartCount}
</span>
```

---

## üî¥ CORRECTION #2: Ic√¥ne Panier Cliquable

**Fichier:** `src/components/Header.tsx`

**Ligne 150-159:** Remplacer
```typescript
// ‚ùå AVANT
<button className={...}>
  <ShoppingBag className="h-5 w-5" />
  <span className="...">{cartCount}</span>
</button>

// ‚úÖ APR√àS
<Link to="/cart">
  <button className={...}>
    <ShoppingBag className="h-5 w-5" />
    <span className="...">{cartCount}</span>
  </button>
</Link>
```

---

## üî¥ CORRECTION #3: Retirer Redirection Admin Forc√©e

**Fichier:** `src/App.tsx`

**Ligne 39-54:** SUPPRIMER compl√®tement le composant
```typescript
// ‚ùå SUPPRIMER TOUT CECI
const AdminRedirector = () => {
  const { user, loading: authLoading } = useAuth();
  const { isAdmin, loading: roleLoading } = useUserRole();
  const navigate = useNavigate();
  const location = useLocation();

  useEffect(() => {
    if (!authLoading && !roleLoading && user && isAdmin) {
      if (!location.pathname.startsWith("/admin")) {
        navigate("/admin", { replace: true });
      }
    }
  }, [user, isAdmin, authLoading, roleLoading, location, navigate]);

  return null;
};
```

**Ligne 67:** Supprimer l'utilisation
```typescript
// ‚ùå SUPPRIMER
<AdminRedirector />
```

---

## üî¥ CORRECTION #4: Recherche Fonctionnelle

**Fichier:** `src/components/Header.tsx`

**Ligne 99-105:** Remplacer
```typescript
// ‚ùå AVANT
<button className={...}>
  <Search className="h-5 w-5" />
</button>

// ‚úÖ APR√àS
<Link to="/search">
  <button className={...}>
    <Search className="h-5 w-5" />
  </button>
</Link>
```

---

## üî¥ CORRECTION #5: Panier Sans Connexion

**Fichier:** `src/pages/ProductDetails.tsx`

**Ligne 58-66:** Remplacer la fonction compl√®te
```typescript
// ‚ùå AVANT
const handleAddToCart = (productData, quantity = 1) => {
  if (!user) {
    toast.info('Veuillez vous connecter...');
    navigate('/auth');
    return;
  }
  addToCart(productData, quantity);
  toast.success(`${quantity} x ${productData.name} ajout√© !`);
};

// ‚úÖ APR√àS
const handleAddToCart = (productData, quantity = 1) => {
  // Le CartContext g√®re d√©j√† les utilisateurs non connect√©s via localStorage
  addToCart(productData, quantity);
  toast.success(`${quantity} x ${productData.name} ajout√© au panier !`);
  
  if (!user) {
    toast.info('Connectez-vous pour sauvegarder votre panier', {
      autoClose: 5000,
    });
  }
};
```

**Appliquer la m√™me correction dans:**
- `src/pages/Shop.tsx` ligne 124-136
- `src/pages/CategoryPage.tsx`
- `src/pages/Search.tsx`
- `src/components/boutique/FeaturedProducts.tsx`

---

## üî¥ CORRECTION #6: Index Base de Donn√©es

**Cr√©er fichier:** `database_indexes.sql`

```sql
-- Index pour am√©liorer les performances

-- Produits
CREATE INDEX IF NOT EXISTS idx_products_category ON products(category_id);
CREATE INDEX IF NOT EXISTS idx_products_active ON products(is_active);
CREATE INDEX IF NOT EXISTS idx_products_name ON products(name);
CREATE INDEX IF NOT EXISTS idx_products_price_eur ON products(price_eur);

-- Commandes
CREATE INDEX IF NOT EXISTS idx_orders_user ON orders(user_id);
CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
CREATE INDEX IF NOT EXISTS idx_orders_created ON orders(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_orders_currency ON orders(currency);

-- Panier
CREATE INDEX IF NOT EXISTS idx_cart_user ON cart_items(user_id);
CREATE INDEX IF NOT EXISTS idx_cart_product ON cart_items(product_id);
CREATE INDEX IF NOT EXISTS idx_cart_added ON cart_items(added_at DESC);

-- Utilisateurs
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);

-- Articles de commande
CREATE INDEX IF NOT EXISTS idx_order_items_order ON order_items(order_id);
CREATE INDEX IF NOT EXISTS idx_order_items_product ON order_items(product_id);

-- Logs paiement
CREATE INDEX IF NOT EXISTS idx_payment_logs_order ON payment_logs(order_id);
CREATE INDEX IF NOT EXISTS idx_payment_logs_user ON payment_logs(user_id);
```

**Ex√©cuter:**
```bash
psql -U tinaboutique_user -d tinaboutique_db -f database_indexes.sql
```

---

## üî¥ CORRECTION #7: Cr√©er .gitignore Complet

**Fichier:** `.gitignore`

```
# Fichiers sensibles
.env
.env.local
.env.production

# Node
node_modules/
npm-debug.log
yarn-error.log
package-lock.json
yarn.lock
.pnpm-debug.log

# Build
dist/
build/
*.tsbuildinfo

# Uploads
uploads/
*.log

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Tests
coverage/
.nyc_output/

# Backup
*.sql
backup_*
```

---

## üî¥ CORRECTION #8: Cr√©er .env.example

**Fichier:** `.env.example`

```env
# Base de donn√©es PostgreSQL
DB_USER=tinaboutique_user
DB_PASSWORD=VOTRE_MOT_DE_PASSE_FORT
DB_HOST=localhost
DB_DATABASE=tinaboutique_db
DB_PORT=5432

# JWT Secret (g√©n√©rer avec: openssl rand -hex 32)
JWT_SECRET=VOTRE_JWT_SECRET_64_CARACTERES

# Cl√© de chiffrement RGPD (g√©n√©rer avec: openssl rand -hex 32)
ENCRYPTION_KEY=VOTRE_ENCRYPTION_KEY_64_CARACTERES

# Paiements Mobile Money RDC
FLUTTERWAVE_PUBLIC_KEY=VOTRE_CLE_PUBLIQUE_FLUTTERWAVE
FLUTTERWAVE_SECRET_KEY=VOTRE_CLE_SECRETE_FLUTTERWAVE
FLUTTERWAVE_WEBHOOK_SECRET=VOTRE_WEBHOOK_SECRET

ORANGE_MONEY_API_KEY=VOTRE_CLE_ORANGE
ORANGE_MONEY_API_SECRET=VOTRE_SECRET_ORANGE
ORANGE_MONEY_MERCHANT_ID=VOTRE_MERCHANT_ID

AIRTEL_MONEY_API_KEY=VOTRE_CLE_AIRTEL
AIRTEL_MONEY_API_SECRET=VOTRE_SECRET_AIRTEL
AIRTEL_MONEY_MERCHANT_ID=VOTRE_MERCHANT_ID

# Configuration environnement
NODE_ENV=development
FRONTEND_URL=http://localhost:8081
PAYMENT_ENV=sandbox

# AWS (optionnel - pour stockage images)
AWS_REGION=eu-north-1
AWS_ACCESS_KEY_ID=VOTRE_ACCESS_KEY
AWS_SECRET_ACCESS_KEY=VOTRE_SECRET_KEY

# Email (optionnel - SendGrid, Mailgun, etc.)
EMAIL_PROVIDER=sendgrid
EMAIL_API_KEY=VOTRE_CLE_API_EMAIL
EMAIL_FROM=noreply@votredomaine.com
```

---

## üî¥ CORRECTION #9: Script Backup DB

**Cr√©er fichier:** `scripts/backup-db.sh`

```bash
#!/bin/bash

# Configuration
DB_NAME="tinaboutique_db"
DB_USER="tinaboutique_user"
BACKUP_DIR="./backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/backup_$DATE.sql"

# Cr√©er dossier backups si inexistant
mkdir -p $BACKUP_DIR

# Backup
echo "üîÑ Backup de la base de donn√©es..."
pg_dump -U $DB_USER $DB_NAME > $BACKUP_FILE

# Compression
echo "üì¶ Compression..."
gzip $BACKUP_FILE

# Nettoyage (garder seulement les 7 derniers jours)
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete

echo "‚úÖ Backup termin√©: $BACKUP_FILE.gz"
```

**Rendre ex√©cutable:**
```bash
chmod +x scripts/backup-db.sh
```

**Ajouter au cron (Linux/Mac):**
```bash
crontab -e
# Ajouter:
0 2 * * * /chemin/vers/projet/scripts/backup-db.sh
```

---

## üî¥ CORRECTION #10: Cr√©er Service Paiement Basique

**Cr√©er fichier:** `src/payments.ts`

```typescript
import crypto from 'crypto';
import { pool } from './db';

export interface PaymentIntent {
  id: string;
  amount: number;
  currency: string;
  orderId: string;
  customerId: string;
  paymentMethod: string;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  expiresAt: Date;
  createdAt: Date;
}

class PaymentService {
  async createPaymentIntent(data: {
    amount: number;
    currency: string;
    orderId: string;
    customerId: string;
    paymentMethod: string;
    metadata?: any;
  }): Promise<PaymentIntent> {
    const intentId = 'pi_' + crypto.randomBytes(16).toString('hex');
    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24h

    // Logger dans payment_logs
    await pool.query(`
      INSERT INTO payment_logs (
        transaction_id, order_id, user_id, payment_method,
        amount, currency, status, action, metadata
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    `, [
      intentId,
      data.orderId,
      data.customerId,
      data.paymentMethod,
      data.amount,
      data.currency,
      'pending',
      'create_intent',
      JSON.stringify(data.metadata || {})
    ]);

    return {
      id: intentId,
      amount: data.amount,
      currency: data.currency,
      orderId: data.orderId,
      customerId: data.customerId,
      paymentMethod: data.paymentMethod,
      status: 'pending',
      expiresAt,
      createdAt: new Date(),
    };
  }

  async processPayment(intentId: string, paymentData: any): Promise<any> {
    // TODO: Impl√©menter vraies int√©grations selon paymentMethod
    // Pour l'instant, simulation de succ√®s

    await pool.query(`
      UPDATE payment_logs
      SET status = 'completed', action = 'process_payment'
      WHERE transaction_id = $1
    `, [intentId]);

    // Mettre √† jour le statut de la commande
    const log = await pool.query(`
      SELECT order_id FROM payment_logs WHERE transaction_id = $1
    `, [intentId]);

    if (log.rows.length > 0) {
      await pool.query(`
        UPDATE orders SET status = 'completed' WHERE id = $1
      `, [log.rows[0].order_id]);
    }

    return {
      success: true,
      transactionId: intentId,
      status: 'completed',
      message: 'Paiement trait√© avec succ√®s (mode test)'
    };
  }

  async handleWebhook(provider: string, signature: string, payload: any): Promise<boolean> {
    // TODO: V√©rifier la signature selon le provider
    // TODO: Traiter le payload
    
    console.log(`Webhook re√ßu de ${provider}`);
    
    return true; // Temporaire
  }
}

export const paymentService = new PaymentService();
```

---

## üîê CORRECTION #11: S√©curiser les Cl√©s

### √âtape 1: R√©voquer les cl√©s AWS actuelles
1. Se connecter √† AWS Console
2. IAM ‚Üí Utilisateurs ‚Üí Votre utilisateur
3. Onglet "Security credentials"
4. "Make inactive" puis "Delete" pour la cl√© expos√©e

### √âtape 2: G√©n√©rer de nouvelles cl√©s
```bash
# JWT Secret
openssl rand -hex 32

# Encryption Key
openssl rand -hex 32

# Nouveau mot de passe DB
openssl rand -base64 32
```

### √âtape 3: Mettre √† jour .env avec les nouvelles valeurs
```env
JWT_SECRET="NOUVELLE_VALEUR_GENEREE"
ENCRYPTION_KEY="NOUVELLE_VALEUR_GENEREE"
DB_PASSWORD="NOUVEAU_MOT_DE_PASSE"
AWS_ACCESS_KEY_ID="NOUVELLE_CLE_AWS"
AWS_SECRET_ACCESS_KEY="NOUVEAU_SECRET_AWS"
```

### √âtape 4: Ajouter .env au .gitignore
```bash
echo ".env" >> .gitignore
git rm --cached .env
git commit -m "security: Remove .env from version control"
```

---

## üìã ORDRE D'APPLICATION

### Phase 1 (30 min)
1. ‚úÖ Correction #11 (S√©curit√© - URGENT)
2. ‚úÖ Correction #7 (.gitignore)
3. ‚úÖ Correction #8 (.env.example)

### Phase 2 (2h)
4. ‚úÖ Correction #1 (Badge panier)
5. ‚úÖ Correction #2 (Ic√¥ne cliquable)
6. ‚úÖ Correction #3 (Redirection admin)
7. ‚úÖ Correction #4 (Recherche)

### Phase 3 (3h)
8. ‚úÖ Correction #5 (Panier sans connexion)
9. ‚úÖ Correction #10 (Service paiement)
10. ‚úÖ Correction #6 (Index DB)
11. ‚úÖ Correction #9 (Backup)

---

## ‚úÖ TEST APR√àS CORRECTIONS

### Test 1: Badge Panier
1. D√©marrer l'app
2. Ajouter un produit au panier
3. V√©rifier que le badge affiche "1"
4. Ajouter un autre produit
5. V√©rifier que le badge affiche "2"

### Test 2: Navigation Panier
1. Cliquer sur l'ic√¥ne panier dans le header
2. V√©rifier la redirection vers /cart
3. V√©rifier l'affichage des articles

### Test 3: Admin
1. Se connecter en tant qu'admin
2. Naviguer vers /boutique
3. V√©rifier que la navigation fonctionne

### Test 4: Recherche
1. Cliquer sur l'ic√¥ne de recherche
2. V√©rifier la redirection vers /search

### Test 5: Panier Anonyme
1. Se d√©connecter (ou mode incognito)
2. Ajouter un produit au panier
3. V√©rifier l'ajout r√©ussi
4. V√©rifier localStorage

---

## üéâ R√âSULTAT ATTENDU

Apr√®s ces corrections:
- ‚úÖ Panier fonctionnel √† 100%
- ‚úÖ Navigation fluide
- ‚úÖ S√©curit√© renforc√©e
- ‚úÖ Performance am√©lior√©e
- ‚úÖ Admin peut tester le site

**L'application sera pr√™te pour des tests utilisateurs en environnement de staging.**
